%% Users manual for C++ BOUT code

\documentclass[12pt]{article}
\usepackage[nofoot]{geometry}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{hyperref}

\usepackage{listings}
\usepackage{color}
\usepackage{textcomp}
\usepackage{amsmath}

% Add an index
\usepackage{makeidx}
\makeindex

\definecolor{listinggray}{gray}{0.9}
\definecolor{lbcolor}{rgb}{0.95,0.95,0.95}
\lstset{
	backgroundcolor=\color{lbcolor},
        language=C++,
	keywordstyle=\bfseries\ttfamily\color[rgb]{0,0,1},
	identifierstyle=\ttfamily,
	commentstyle=\color[rgb]{0.133,0.545,0.133},
	stringstyle=\ttfamily\color[rgb]{0.627,0.126,0.941},
	showstringspaces=false,
	basicstyle=\small,
	numberstyle=\footnotesize,
	numbers=left,
	stepnumber=1,
	numbersep=10pt,
	tabsize=2,
	breaklines=true,
	prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookleftarrow}},
	breakatwhitespace=false,
	aboveskip={0.5\baselineskip},
        columns=fixed,
        upquote=true,
        extendedchars=true,
        morekeywords={Field2D,Field3D,Vector2D,Vector3D,real,FieldGroup},
}

%% Modify margins
\addtolength{\oddsidemargin}{-.25in}
\addtolength{\evensidemargin}{-.25in}
\addtolength{\textwidth}{0.5in}
\addtolength{\textheight}{0.25in}
%% SET HEADERS AND FOOTERS

\pagestyle{fancy}
\fancyfoot{}
\renewcommand{\sectionmark}[1]{         % Lower case Section marker style
  \markright{\thesection.\ #1}}
\fancyhead[LE,RO]{\bfseries\thepage}    % Page number (boldface) in left on even
                                        % pages and right on odd pages
\renewcommand{\headrulewidth}{0.3pt}

\newcommand{\code}[1]{\texttt{#1}}
\newcommand{\bfile}[1]{\texttt{\bf 1}}

%% commands for boxes with important notes
\newlength{\notewidth}
\addtolength{\notewidth}{\textwidth}
\addtolength{\notewidth}{-3.\parindent}
\newcommand{\note}[1]{
\fbox{
\begin{minipage}{\notewidth}
{\bf NOTE}: #1
\end{minipage}
}}


\newcommand{\rbtsq}{\ensuremath{\left(R\Bp\right)^2}}
\newcommand{\sbt}{\ensuremath{\sigma_{B\theta}}}
\newcommand{\apar}{\ensuremath{A_{||}}}

\newcommand{\pow}{\ensuremath{\wedge} }
\newcommand{\poweq}{\ensuremath{\wedge =} }

\newcommand{\dd}[2]{\ensuremath{\frac{d #1}{d #2}}}
\newcommand{\ddd}[2]{\ensuremath{\frac{d^2 #1}{d #2^2}}}
\newcommand{\deriv}[2]{\ensuremath{\frac{\partial #1}{\partial #2}}}
\newcommand{\dderiv}[2]{\ensuremath{\frac{\partial^2 #1}{\partial {#2}^2}}}
\newcommand{\Vpar}{\ensuremath{V_{||}}}
\newcommand{\Gradpar}{\ensuremath{\partial_{||}}}
\newcommand{\Divpar}{\ensuremath{\nabla_{||}}}
\newcommand{\DivXgradX}[2]{\ensuremath{\nabla_\psi\left(#1\partial_\psi 
#2\right)}}
\newcommand{\DivParGradPar}[2]{\ensuremath{\nabla_{||}\left(#1\partial_{||} 
#2\right)}}

\newcommand{\hthe}{\ensuremath{h_\theta}}
\newcommand{\Bp}{\ensuremath{B_{\text{pol}}}}
\newcommand{\Bt}{\ensuremath{B_{\text{tor}}}}

\newcommand{\ve}[1]{\ensuremath{\boldsymbol{#1}}}
\newcommand{\hv}[1]{\hat{\ve{#1}}}
\newcommand{\bvec}{\ve{b}}
\newcommand{\kvec}{\ve{\kappa}}
\newcommand{\bxk}{\bvec\times\kvec\cdot\nabla}
\newcommand{\Bvec}{\ve{B}}
\newcommand{\Bbar}{\overline{B}}
\newcommand{\Lbar}{\overline{L}}
\newcommand{\Tbar}{\overline{T}}
\newcommand{\Jvec}{\ve{J}}
\newcommand{\Jpar}{J_{||}}
\newcommand{\delp}{\nabla_\perp^2}
\newcommand{\Div}[1]{\ensuremath{\nabla\cdot #1 }}
\newcommand{\Curl}[1]{\ensuremath{\nabla\times #1 }}
\newcommand{\rbp}{\ensuremath{R\Bp}}
\newcommand{\rbpsq}{\ensuremath{\left(\rbp\right)^2}}
\newcommand{\Rvec}{\ensuremath{\hv{R}}}
\newcommand{\Zvec}{\ensuremath{\hv{Z}}}
\newcommand{\phivec}{\ensuremath{\hv{\phi}}}
\newcommand{\ehat}{\ensuremath{\hv{e}}}

\begin{document}

\title{Field-aligned coordinates}
\author{B.Dudson\S, M.V.Umansky\dag, L.C.Wang\ddag, X.Q.Xu\dag,
L.L.LoDestro\dag \\
\\
  \S Department of Physics, University of York, UK \\
  \dag Lawrence Livermore National Laboratory, USA \\
  \ddag IFTS, China}
\date{29$^{th}$ June 2011\\Revised 12$^{th}$ May 2015}
\maketitle

\tableofcontents



\section{Introduction}
This manual covers the field-aligned coordinate system used in many BOUT++
tokamak models, and useful derivations and expressions.




\section{Orthogonal toroidal coordinates}
\label{sec:coordinates}
Starting with an orthogonal toroidal coordinate system $\left(\psi, \theta,
\zeta\right)$, where $\psi$ is the poloidal flux, $\theta$ the poloidal angle
(from $0$ to $2\pi$), and $\zeta$ the toroidal angle (also $0$ to $2\pi$). We 
have that the magnetic field $\Bvec$ can be expressed as
%
\begin{align*}
 \Bvec =& B_\theta \nabla \theta + B_\zeta \nabla \zeta\\
       =& B_\theta \ve{e}_\theta + B_\zeta \ve{e}_\zeta\\
       =& \Bp h_\theta \ve{e}_\theta + \Bt R \ve{e}_\zeta\\
       =& \Bp \hv{e}_\theta + \Bt \hv{e}_\zeta
\end{align*}
%
The magnitudes of the unit vectors are
%
\begin{align*}
\left|\ve{e}_\psi\right| = \frac{1}{R\left|\Bp\right|} \qquad
\left|\ve{e}_\theta\right| = \hthe \qquad
\left|\ve{e}_\zeta\right| = R
\end{align*}
%
where $\hthe$ is the poloidal arc length per radian.
The coordinate system is right handed, so
$\hv{e}_\psi\times\hv{e}_\theta = \hv{e}_\zeta$,
$\hv{e}_\psi\times\hv{e}_\zeta = -\hv{e}_\theta$ and
$\hv{e}_\theta\times\hv{e}_\zeta = \hv{e}_\psi$. The covariant
metric coefficients are
%
\begin{align*}
g_{\psi\psi} = \frac{1}{\left(R\left|\Bp\right|\right)^2} \qquad
g_{\theta\theta} = h_\theta^2 \qquad
g_{\zeta\zeta} = R^2
\end{align*}
%
and the magnitudes of the reciprocal vectors are therefore
%
\begin{align*}
\left|\nabla\psi\right| = R\left|\Bp\right| \qquad
\left|\nabla\theta\right| = \frac{1}{h_\theta} \qquad
\left|\nabla\zeta\right| = \frac{1}{R}
\end{align*}
%
Because the coordinate system is orthogonal, $g^{ii} = 1/g_{ii}$ and so the
cross-products can be calculated as
%
\begin{align*}
\nabla\psi\times\nabla\theta = &\hv{e}^\psi\times \hv{e}^\theta =
g^{\psi\psi}\ve{e}_\psi\times g^{\theta\theta}\ve{e}_\theta \nonumber \\
= & g^{\psi\psi}g^{\theta\theta}h_\psi
h_\theta \hat{e}_\psi\times\hat{e}_\theta \nonumber \\
= &\frac{1}{h_\psi h_\theta}\hv{e}_\zeta
= \frac{R\left|\Bp\right|}{h_\theta}\hat{e}_\zeta
\end{align*}
%
Similarly,
%
\begin{align*}
\nabla\psi\times\nabla\zeta = 
-\left|\Bp\right|\hv{e}_\theta \qquad
\nabla\theta\times\nabla\zeta = \frac{1}{Rh_\theta}\hv{e}_\psi =
\frac{1}{h_\theta R^2\left|\Bp\right|}\nabla \psi
\end{align*}
%



\section{Field-aligned coordinates}
In order to efficiently simulate (predominantly) field-aligned structures,
grid-points
are placed in a field-aligned coordinate system. We define $\sigma_{B\theta}
\equiv \Bp / \left|\Bp\right|$
i.e. the sign of the poloidal field. The new coordinates $\left(x,y,z\right)$
are defined by:
%
\begin{align}
x = \sbt\left(\psi - \psi_0\right) \qquad
y = \theta \qquad
z = \sigma_{B\theta}
    \left(\zeta - 
          \int_{\theta_0}^{\theta}\nu\left(\psi,\theta\right)d\theta\right)
\label{eq:coordtransform}
\end{align}
%
Where $\nu$ is the local field-line pitch given by
%
\begin{align*}
\nu\left(\psi, \theta\right) =
\frac{\Bvec\cdot\nabla\zeta}{\Bvec\cdot\nabla\theta} =
\frac{\Bt\hthe}{\Bp R} = \frac{\left(F/R\right)h_\theta}{\Bp R} = FJ/R^2
\end{align*}
%
The coordinate system is chosen so that $x$ increases radially outwards, from
plasma to the wall.
The sign of the toroidal field $\Bt$ can then be either + or -.

The contravariant basis vectors are therefore
%
\begin{align*}
\nabla x = \sbt\nabla \psi \qquad \nabla y = \nabla \theta \qquad \nabla z =
\sbt\left(\nabla\zeta - \left[\int_{\theta_0}^\theta\deriv{\nu\left(\psi,
\theta\right)}{\psi} d\theta\right] \nabla\psi - \nu\left(\psi,
\theta\right)\nabla\theta\right)
\end{align*}
%
The term in square brackets is the integrated local shear:
%
\begin{align*}
I = \int_{y_0}^y\frac{\partial\nu\left(x, y\right)}{\partial\psi}dy
\end{align*}
%



\subsection{Magnetic field}
Magnetic field is given in Clebsch form by:
%
\begin{align*}
\Bvec = \nabla z\times \nabla x = \frac{1}{J}\ve{e}_y
\end{align*}
%
The contravariant components of this are then
%
\begin{align*}
B^y = \frac{\Bp}{\hthe} \qquad B^x = B^z = 0
\end{align*}
%
i.e. $\Bvec$ can be written as
%
\begin{align*}
\Bvec = \frac{\Bp}{\hthe}\ve{e}_y
\end{align*}
%
and the covariant components calculated using $g_{ij}$ as
%
\begin{align*}
B_x = \sbt\Bt I R \qquad B_y = \frac{B^2 \hthe}{\Bp} \qquad B_z = \sbt\Bt R
\end{align*}
%
The unit vector in the direction of equilibrium $\Bvec$ is therefore
%
\begin{align*}
\ve{b} = \frac{1}{JB}\ve{e}_y = \frac{1}{JB}\left[g_{xy}\nabla x
+ g_{yy}\nabla y + g_{yz}\nabla z\right]
\end{align*}



\subsection{Jacobian and metric tensors}
The Jacobian of this coordinate system is
%
\begin{align*}
J^{-1} \equiv \left(\nabla x\times\nabla y\right)\cdot\nabla z = \Bp / \hthe
\end{align*}
%
which can be either positive or negative, depending on the sign of $\Bp$.
The contravariant metric tensor is given by:
%
\begin{align*}
g^{ij} \equiv \ve{e}^i \cdot\ve{e}^j \equiv \nabla u^i \cdot \nabla u^j =
\left(\begin{array}{ccc}
\left(R\Bp\right)^2 & 0 & -I\left(R\Bp\right)^2 \\
0 & 1 / \hthe^2 & -\sbt\nu / \hthe^2 \\
-I\left(R\Bp\right)^2 & -\sbt\nu / \hthe^2 & I^2\left(R\Bp\right)^2 + B^2 /
\left(R\Bp\right)^2 \end{array} \right)
\end{align*}
%
and the covariant metric tensor:
%
\begin{align*}
g_{ij} \equiv \ve{e}_i \cdot\ve{e}_j = \left(\begin{array}{ccc}
I^2 R^2 + 1 / \rbpsq & \sbt\Bt\hthe I R / \Bp & I R^2 \\
\sbt\Bt\hthe I R / \Bp & B^2\hthe^2 / \Bp^2 & \sbt\Bt\hthe R / \Bp \\
I R^2 & \sbt\Bt\hthe R / \Bp & R^2 \end{array} \right)
\end{align*}



\subsection{Differential operators}
The derivative of a scalar field $f$ along the \emph{unperturbed} magnetic
field $\ve{b}_0$ is given by
%
\begin{align*}
\partial^0_{||}f \equiv \ve{b}_0 \cdot\nabla f =
\frac{1}{\sqrt{g_{yy}}}\deriv{f}{y} = \frac{\Bp}{B\hthe}\deriv{f}{y}
\end{align*}
%
whilst the parallel divergence is given by
%
\begin{align*}
\nabla^0_{||}f = B_0\partial^0_{||}\left(\frac{f}{B_0}\right)
\end{align*}
%
Using equation (\ref{eq:general_laplacian}), the laplacian operator is given by
%
\begin{align*}
\nabla^2 = &\frac{\partial^2}{\partial x^2}\left|\nabla x\right|^2 +
\frac{\partial^2}{\partial y^2}\left|\nabla y\right|^2 +
\frac{\partial^2}{\partial z^2}\left|\nabla z\right|^2 \nonumber \\
&-2\frac{\partial^2}{\partial x\partial z}I\left(R\Bp\right)^2 -
2\frac{\partial^2}{\partial y\partial z}\frac{\nu}{h_\theta^2}\\
&+\frac{\partial}{\partial x}\nabla^2x + \frac{\partial}{\partial y}\nabla^2y +
\frac{\partial}{\partial z}\nabla^2z \nonumber
\end{align*}
%
Using equation (\ref{eq:laplace_expand}) for $\nabla^2x = -\Gamma^x$ etc, the
values are
%
\begin{align*}
\nabla^2x = \frac{\Bp}{h_\theta}\frac{\partial}{\partial 
x}\left(h_\theta
R^2\Bp\right) \qquad
\nabla^2y = \frac{\Bp}{h_\theta}\frac{\partial}{\partial
y}\left(\frac{1}{\Bp h_\theta}\right)
\end{align*}
%
%
\begin{align*}
\nabla^2z = -\frac{\Bp}{h_\theta}\left[\frac{\partial}{\partial
x}\left(IR^2\Bp h_\theta\right) + \frac{\partial}{\partial
y}\left(\frac{\nu}{\Bp h_\theta}\right)\right]
\end{align*}
%
Neglecting some parallel derivative terms, the perpendicular Laplacian can be
written:
%
\begin{align*}
\delp = \rbpsq\left[\dderiv{}{x} - 2I\frac{\partial^2}{\partial z\partial x} +
\left(I^2 + \frac{B^2}{\left(\rbp\right)^4}\right)\dderiv{}{z}\right] +
\nabla^2 x \deriv{}{x} + \nabla^2 z\deriv{}{z}
\end{align*}
%
The second derivative along the equilibrium field
%
\begin{align*}
\partial^2_{||}\phi = \partial^0_{||}\left(\partial^0_{||}\phi\right) =
\frac{1}{\sqrt{g_{yy}}}\deriv{}{y}\left(\frac{1}{\sqrt{g_{yy}}}\right)\deriv{
\phi}{y} + \frac{1}{g_{yy}}\frac{\partial^2\phi}{\partial y^2}
\end{align*}
%
A common expression (Poisson bracket in reduced MHD) is:
%
\begin{align*}
\bvec_0\cdot\nabla\phi\times\nabla A =
\frac{1}{J\sqrt{g_{yy}}}\left[\left(g_{yy}\deriv{\phi}{z} -
g_{yz}\deriv{\phi}{y}\right)\deriv{A}{x} + \left(g_{yz}\deriv{\phi}{x} -
g_{xy}\deriv{\phi}{z}\right)\deriv{A}{y} + \left(g_{xy}\deriv{\phi}{y} -
g_{yy}\deriv{\phi}{x}\right)\deriv{A}{z}\right]
\end{align*}
%
The perpendicular gradient operator:
%
\begin{align*}
\nabla_\perp \equiv& \nabla -
\ve{b}\left(\ve{b}\cdot\nabla\right) \\
 =& \nabla x\left(\deriv{}{x} -
\frac{g_{xy}}{\left(JB\right)^2}\deriv{}{y}\right) + \nabla z\left(\deriv{}{z}
- \frac{g_{yz}}{\left(JB\right)^2}\deriv{}{y}\right)
\end{align*}



\subsection{$J\times B$ in field-aligned coordinates}
\label{sec:jxb_fac}
Components of the magnetic field in field-aligned coordinates:
%
\begin{align*}
B^y = \frac{\Bp}{\hthe} \qquad B^x = B^z = 0
\end{align*}
%
and
%
\begin{align*}
B_x = \sbt\Bt I R \qquad B_y = \frac{B^2\hthe}{\Bp} \qquad B_z = \sbt\Bt R
\end{align*}
%
Calculate current $\Jvec = \frac{1}{\mu}\Curl{\Bvec}$
%
\begin{align*}
\left(\Curl{\Bvec}\right)^x = \frac{1}{J}\left(\deriv{B_z}{y} -
\deriv{B_y}{z}\right) = 0
\end{align*}
%
since $\Bt R$ is a flux-surface quantity, and $\Bvec$ is axisymmetric.
%
\begin{align*}
\left(\Curl{\Bvec}\right)^y =& -\sbt\frac{\Bp}{\hthe}\deriv{}{x}\left(\Bt
R\right) \\
\left(\Curl{\Bvec}\right)^z =&
\frac{\Bp}{\hthe}\left[\deriv{}{x}\left(\frac{B^2\hthe}{\Bp}\right) -
\sbt\deriv{}{y}\left(\Bt I R\right)\right]
\end{align*}
%
The second term can be simplified, again using $\Bt R$ constant on
flux-surfaces:
%
\begin{align*}
\deriv{}{y}\left(\Bt I R\right) = \sbt\Bt R\deriv{\nu}{x} \qquad \nu =
\frac{\hthe\Bt}{R\Bp}
\end{align*}
%
From these, calculate covariant components:
%
\begin{align}
\left(\Curl{\Bvec}\right)_x =&
-\Bt I R \deriv{}{x}\left(\Bt R\right) +
\frac{IR^2\Bp}{\hthe}\left[\deriv{}{x}\left(\frac{B^2\hthe}{\Bp}\right) - \Bt
R\deriv{\nu}{x}\right] \nonumber\\
%
\left(\Curl{\Bvec}\right)_y =& -\sbt\frac{B^2\hthe}{\Bp}\deriv{}{x}\left(\Bt
R\right) + \sbt\Bt R\left[\deriv{}{x}\left(\frac{B^2\hthe}{\Bp}\right) - \Bt
R\deriv{\nu}{x}\right] \label{eq:curlb_y}\\
%
\left(\Curl{\Bvec}\right)_z =& -\Bt R\deriv{}{x}\left(\Bt R\right) +
\frac{R^2\Bp}{\hthe}\left[\deriv{}{x}\left(\frac{B^2\hthe}{\Bp}\right) - \Bt
R\deriv{\nu}{x}\right] \nonumber
\end{align}
%
Calculate $\Jvec\times\Bvec$ using
%
\begin{align*}
\ve{e}^i = \frac{1}{J}\left(\ve{e}_j \times \ve{e}_k\right) \qquad
\ve{e}_i = J\left(\ve{e}^j \times \ve{e}^k\right) \qquad i,j,k
\texttt{ cyc } 1,2,3
\end{align*}
%
gives
%
\begin{align*}
\mu_0 \left(\Jvec\times\Bvec\right)^x =&
\frac{1}{J}\left[\left(\Curl{\Bvec}\right)_y B_z - \left(\Curl{\Bvec}\right)_z
B_y \right]\\
=& -\frac{\Bp^3 R^2}{\hthe}\left[\deriv{}{x}\left(\frac{B^2\hthe}{\Bp}\right)
- \Bt R\deriv{\nu}{x}\right]
\end{align*}
%
Covariant components of $\nabla P$:
%
\begin{align*}
\left(\nabla P\right)_x = \deriv{P}{x} \qquad \left(\nabla P\right)_y =
\left(\nabla P\right)_z = 0
\end{align*}
%
and contravariant:
%
\begin{align*}
\left(\nabla P\right)^x = \rbpsq\deriv{P}{x} \qquad \left(\nabla P\right)^y = 0
\qquad \left(\nabla P\right)^z = -I\rbpsq\deriv{P}{x}
\end{align*}
%
Hence equating contravariant x components of $\Jvec\times\Bvec = \nabla P$,
%
\begin{align}
\deriv{}{x}\left(\frac{B^2\hthe}{\Bp}\right) - \Bt
R\deriv{}{x}\left(\frac{\Bt\hthe}{R\Bp}\right) +
\frac{\mu_0\hthe}{\Bp}\deriv{P}{x} = 0
\label{eq:xbalance}
\end{align}
%
Use this to calculate $\hthe$ profiles (need to fix $\hthe$ at one radial
location).

Close to x-points, the above expression becomes singular, so a better way to
write it is:
%
\begin{align*}
\deriv{}{x}\left(B^2\hthe\right) - \hthe\Bp\deriv{\Bp}{x} - \Bt
R\deriv{}{x}\left(\frac{\Bt\hthe}{R}\right) + \mu_0\hthe\deriv{P}{x} = 0
\end{align*}
%
For solving force-balance by adjusting $P$ and $f$ profiles, the form used is
%
\begin{align*}
\Bt\hthe\deriv{\Bt}{x} + \frac{\Bt^2\hthe}{R}\deriv{R}{x} +
\mu_0\hthe\deriv{P}{x} = -\Bp\deriv{}{x}\left(\Bp\hthe\right)
\end{align*}
%
A quick way to calculate f is to rearrange this to:
%
\begin{align*}
\deriv{\Bt}{x} = \Bt\left[-\frac{1}{R}\deriv{R}{x}\right] +
\frac{1}{\Bt}\left[-\mu_0\deriv{P}{x} -
\deriv{\Bp}{\hthe}\deriv{}{x}\left(\Bp\hthe\right)\right]
\end{align*}
%
and then integrate this using LSODE.



\subsection{Parallel current}
\begin{align*}
J_{||} = \bvec\cdot\Jvec \qquad b^y = \frac{\Bp}{B\hthe}
\end{align*}
%
and from equation \ref{eq:curlb_y}:
%
\begin{align*}
J_y = \frac{\sbt}{\mu_0}\left\{-\frac{B^2\hthe}{\Bp}\deriv{}{x}\left(\Bt
R\right) + \Bt R\left[\deriv{}{x}\left(\frac{B^2\hthe}{\Bp}\right) - \sbt\Bt
R\deriv{\nu}{x}\right]\right\}
\end{align*}
%
since $J_{||} = b^yJ_y$,
%
\begin{align*}
\mu_0 J_{||} =\sbt\frac{\Bp\Bt
R}{B\hthe}\left[\deriv{}{x}\left(\frac{B^2\hthe}{\Bp}\right) - \Bt
R\deriv{\nu}{x}\right] - \sbt B\deriv{}{x}\left(\Bt R\right)
\end{align*}
%



\subsection{Curvature}
For reduced MHD, need to calculate curvature term
$\bvec\times\ve{\kappa}$, where
$\ve{\kappa} = \left(\bvec\cdot\nabla\right)\bvec =
-\bvec\times\left(\nabla\times\bvec\right)$. Re-arranging, this
becomes:
%
\begin{align*}
\bvec\times\ve{\kappa} = \nabla\times\bvec -
\bvec\left(\bvec\cdot\left(\nabla\times\bvec\right)\right)
\end{align*}
%
Components of $\nabla\times\bvec$ are:
%
\begin{align*}
\left(\nabla\times\bvec\right)^x =&
\sbt\frac{\Bp}{\hthe}\deriv{}{y}\left(\frac{\Bt R}{B}\right) \\
\left(\nabla\times\bvec\right)^y =&
-\sbt\frac{\Bp}{\hthe}\deriv{}{x}\left(\frac{\Bt R}{B}\right) \\
\left(\nabla\times\bvec\right)^z =&
\frac{\Bp}{\hthe}\deriv{}{x}\left(\frac{B\hthe}{\Bp}\right) - \sbt\frac{\Bp\Bt
R}{\hthe B}\deriv{\nu}{x} - \sbt I\frac{\Bp}{\hthe}\deriv{}{y}\left(\frac{\Bt
R}{B}\right) \\
\end{align*}
%
giving:
%
\begin{align}
\ve{\kappa} =& -\frac{\Bp}{B h_\theta}\left[\deriv{}{x}\left(\frac{B
h_\theta}{\Bp}\right) - \sbt\deriv{}{y}\left(\frac{\Bt I
R}{B}\right)\right]\nabla x \nonumber \\
&+ \sbt\frac{\Bp}{B h_\theta}\deriv{}{y}\left(\frac{\Bt
R}{B}\right)\nabla z
\label{eq:curvature}
\end{align}
%
%
\begin{align*}
\bvec\cdot\left(\nabla\times\bvec\right) = -\sbt
B\deriv{}{x}\left(\frac{\Bt R}{B}\right) + \sbt \frac{\Bt\Bp
R}{B\hthe}\deriv{}{x}\left(\frac{B\hthe}{\Bp}\right) - \frac{\Bp\Bt^2R^2}{\hthe
B^2}\deriv{\nu}{x}
\end{align*}
%
therefore,
%
\begin{align*}
\left(\bvec\times\ve{\kappa}\right)^x =&
\sbt\frac{\Bp}{\hthe}\deriv{}{y}\left(\frac{\Bt R}{B}\right) =
-\sbt\frac{\Bp\Bt R}{\hthe B^2}\deriv{B}{y} \\
\left(\bvec\times\ve{\kappa}\right)^y =& \frac{\Bp^2\Bt^2
R^2}{B^3\hthe^2}\deriv{\nu}{x} - \sbt\frac{\Bp^2\Bt
R}{B^2\hthe^2}\deriv{}{x}\left(\frac{B\hthe}{\Bp}\right) \\
\left(\bvec\times\ve{\kappa}\right)^z =&
\frac{\Bp}{\hthe}\deriv{}{x}\left(\frac{B\hthe}{\Bp}\right) - \sbt\frac{\Bp\Bt
R}{\hthe B}\deriv{\nu}{x} - I\left(\bvec\times\ve{\kappa}\right)^x
\end{align*}
%
Using equation~\ref{eq:xbalance}:
%
\begin{align*}
B\deriv{}{x}\left(\frac{B\hthe}{\Bp}\right) + \frac{B\hthe}{\Bp}\deriv{B}{x} -
\sbt\Bt R\deriv{}{x}\left(\frac{\Bt\hthe}{R\Bp}\right) +
\frac{\mu_0\hthe}{\Bp}\deriv{P}{x} = 0
\end{align*}
%
we can re-write the above components as:
%
\begin{align*}
\left(\bvec\times\ve{\kappa}\right)^y =& \sbt\frac{\Bp\Bt
R}{B^2\hthe}\left[\frac{\mu_0}{B}\deriv{P}{x} + \deriv{B}{x}\right] \\
\left(\bvec\times\ve{\kappa}\right)^z =& -\frac{\mu_0}{B}\deriv{P}{x}
- \deriv{B}{x} - I\left(\bvec\times\ve{\kappa}\right)^x
\end{align*}



\subsection{Curvature from $\nabla\times\left(\bvec / B\right)$}
The vector $\bvec\times\kvec$ is an approximation of
%
\begin{align*}
\frac{B}{2}\nabla\times\left(\frac{\bvec}{B}\right) \simeq \bvec\times\kvec
\end{align*}
%
so can just derive from the original expression. Using the contravariant
components of
$\bvec$, and the curl operator in curvilinear coordinates (see appendix):

%
\begin{align*}
\nabla\times\left(\frac{\bvec}{B}\right) =&
\frac{\Bp}{\hthe}\left[\left(\deriv{}{x}\left(\frac{\hthe}{\Bp}\right) -
\deriv{}{y}\left(\frac{\sbt\Bt IR}{B^2}\right)\right)\ve{e}_z \right. \\
&+ \deriv{}{y}\left(\frac{\sbt\Bt R}{B^2}\right)\ve{e}_x \\
&+ \left.\deriv{}{x}\left(\frac{\sbt\Bt R}{B^2}\right)\ve{e}_y\right]
\end{align*}
%
This can be simplified using
%
\begin{align*}
\deriv{}{y}\left(\frac{\sbt\Bt IR}{B^2}\right) = I\sbt\Bt
R\deriv{}{y}\left(\frac{1}{B^2}\right) + \frac{\Bt R}{B^2}\deriv{\nu}{x}
\end{align*}
%
to give
%
\begin{align*}
  \left(\bvec\times\kvec\right)^x =& -\sbt\frac{\Bp\Bt R}{\hthe
B^2}\deriv{B}{y} \\
  \left(\bvec\times\kvec\right)^y =&
-\sbt\frac{B\Bp}{2\hthe}\deriv{}{x}\left(\frac{\Bt R}{B^2}\right) \\
  \left(\bvec\times\kvec\right)^z =&
\frac{B\Bp}{2\hthe}\deriv{}{x}\left(\frac{\hthe}{\Bp}\right) - \frac{\Bp\Bt
R}{2\hthe B}\deriv{\nu}{x} - I\left(\bxk\right)^x
\end{align*}
%
The first and second terms in $\left(\bxk\right)^z$ almost cancel, so by
expanding out $\nu$ a better expression is
%
\begin{align*}
\left(\bvec\times\kvec\right)^z = \frac{\Bp^3}{2\hthe
B}\deriv{}{x}\left(\frac{\hthe}{\Bp}\right) - \frac{\Bt
R}{2B}\deriv{}{x}\left(\frac{\hthe}{\Bp}\right)
\end{align*}
%



\subsection{Curvature of a single line}
The curvature vector can be calculated from the field-line toroidal
coordinates $\left(R,Z,\phi\right)$ as follows. The line element
is given by
%
\begin{align*}
d\ve{r} = dR\Rvec + dZ\Zvec + Rd\phi\phivec
\end{align*}
%
Hence the tangent vector is
%
\begin{align*}
\hv{T} \equiv \dd{\ve{r}}{s} = \dd{R}{s}\Rvec + \dd{Z}{s}\Zvec +
R\dd{\phi}{s}\phivec
\end{align*}
%
where $s$ is the distance along the field-line. From this, the curvature vector
is given by
%
\begin{align*}
\kvec \equiv \dd{\ve{T}}{s} =& \ddd{R}{s}\Rvec + \dd{R}{s}\dd{\phi}{s}\phivec
\\
&+ \ddd{Z}{s}\Zvec \\
&+ \dd{R}{s}\dd{\phi}{s}\phivec + R\ddd{\phi}{s}\phivec -
R\left(\dd{\phi}{s}\right)^2 \Rvec
\end{align*}
%
i.e.
%
\begin{align}
\kvec = \left[\ddd{R}{s} - R\left(\dd{\phi}{s}\right)^2\right]\Rvec +
\ddd{Z}{s}\Zvec + \left[2\dd{R}{s}\dd{\phi}{s} + R\ddd{\phi}{s}\right]\phivec
\label{eq:kappaline}
\end{align}
%
Want the components of $\ve{b}\times\kvec$, and since the vector $\ve{b}$
is just the tangent vector $\ve{T}$ above, this can be written using the
cross-products
%
\begin{align*}
\Rvec\times\Zvec = -\phivec \qquad \phivec\times\Zvec = \Rvec \qquad
\Rvec\times\phivec = \Zvec
\end{align*}
%
This vector must then be dotted with $\nabla\psi$, $\nabla\theta$, and
$\nabla\phi$. This is done by writing these vectors in cylindrical coordinates:
%
\begin{align*}
\nabla\psi =& \deriv{\psi}{R}\hv{R} + \deriv{\psi}{Z}\hv{Z} \\
\nabla\theta =& \frac{1}{\Bp\hthe}\nabla\phi\times\nabla\psi =
\frac{1}{R\Bp\hthe}\left(\deriv{\psi}{Z}\hv{R} -
\deriv{\psi}{R}\hv{Z}\right) \\
\end{align*}
%
An alternative is to use
%
\begin{align*}
\bvec \times \nabla\phi = \frac{\sbt}{BR^2}\nabla\psi
\end{align*}
%
and that the tangent vector $\ve{T} = \bvec$. This gives
%
\begin{align}
\nabla\psi = \sbt BR\left[\frac{dR}{ds}\ve{Z} - \frac{dZ}{ds}\ve{R}\right]
\label{eq:flinegradpsi}
\end{align}
%
and so because $d\phi / ds = \Bt / \left(RB\right)$
%
\begin{align}
\kvec\cdot\nabla\psi = \sbt BR\left[ \left( \frac{\Bt^2}{RB^2} -
\ddd{R}{s}\right)\dd{Z}{s} + \ddd{Z}{s}\frac{dR}{ds} \right]
\label{eq:flinekappsi}
\end{align}
%
Taking the cross-product of the tangent vector with the curvature in
equation~\ref{eq:kappaline} above gives
%
\begin{align*}
  \bvec \times\kvec =& \left[\frac{\Bt}{B}\ddd{Z}{s} -
\dd{Z}{s}\left(2\dd{R}{s}\dd{\phi}{s} + R\ddd{\phi}{s}\right)\right]\ve{R} \\
  &+ \left[\dd{R}{s}\left(2\dd{R}{s}\dd{\phi}{s} + R\ddd{\phi}{s}\right) -
\frac{\Bt}{B}\left(\ddd{R}{s} -
R\left(\dd{\phi}{s}\right)^2\right)\right]\ve{Z} \\
  &+ \left[\dd{Z}{s}\left(\ddd{R}{s} - R\left(\dd{\phi}{s}\right)^2\right) -
\dd{R}{s}\ddd{Z}{s}\right]\phivec
\end{align*}
%
The components in field-aligned coordinates can then be calculated:
%
\begin{align*}
\left(\bvec\times\kvec\right)^x =&
\sbt\left(\bvec\times\kvec\right)\cdot\nabla\psi \\
=& \frac{R\Bp^2}{B}\left(2\dd{R}{s}\dd{\phi}{s} + R\ddd{\phi}{s}\right) -
R\Bt\left(\dd{R}{s}\ddd{R}{s} + \dd{Z}{s}\ddd{Z}{s}\right) +
\frac{\Bt^3}{B^2}\dd{R}{s}
\end{align*}



\subsection{Curvature in toroidal coordinates}
In toroidal coordinates $\left(\psi,\theta,\phi\right)$, the $\bvec$ vector
is
%
\begin{align*}
\bvec =& \frac{\Bp}{B}\ehat_\theta + \frac{\Bt}{B}\ehat_\phi \\
=& \frac{\Bp\hthe}{B}\nabla\theta + \frac{R\Bt}{B}\nabla\phi
\end{align*}
%
The curl of this vector is
%
\begin{align*}
\left(\nabla\times\bvec\right)^\psi =&
\frac{1}{\sqrt{g}}\left(\deriv{b_\phi}{\theta} - \deriv{b_\theta}{\phi}\right)
\\
\left(\nabla\times\bvec\right)^\theta =&
\frac{1}{\sqrt{g}}\left(\deriv{b_\psi}{\phi} - \deriv{b_\phi}{\psi}\right) \\
\left(\nabla\times\bvec\right)^\phi =&
\frac{1}{\sqrt{g}}\left(\deriv{b_\theta}{\psi} - \deriv{b_\psi}{\theta}\right)
\end{align*}
%
where $1/\sqrt{g} = \Bp/\hthe$. Therefore, in terms of unit vectors:
%
\begin{align*}
\nabla\times\bvec =
\frac{1}{R\hthe}\deriv{}{\theta}\left(\frac{R\Bt}{B}\right)\ehat_\psi -
\Bp\deriv{}{\psi}\left(\frac{R\Bt}{B}\right)\ehat_\theta + \frac{\Bp
R}{\hthe}\deriv{}{\psi}\left(\frac{\hthe\Bp}{B}\right)\ehat_\phi
\end{align*}



\subsection{$\psi$ derivative of $B$ field}
Needed to calculate magnetic shear, and one way to get the curvature.
The simplest way is to use finite differencing, but there is another way
using local derivatives (implemented using DCT).
%
\begin{align*}
\Bp = \frac{\left|\nabla\psi\right|}{R} =
\frac{1}{R}\sqrt{\left(\deriv{\psi}{R}\right)^2 +
\left(\deriv{\psi}{R}\right)^2}
\end{align*}
%
Using
%
\begin{align*}
\nabla\Bp = \deriv{\Bp}{\psi}\nabla\psi + \deriv{\Bp}{\theta}\nabla\theta +
\deriv{\Bp}{\phi}\nabla\phi
\end{align*}
%
we get
%
\begin{align*}
\nabla\Bp \cdot\nabla\psi = \deriv{\Bp}{\psi}\left|\nabla\psi\right|^2
\end{align*}
%
and so
%
\begin{align*}
\deriv{\Bp}{\psi} = \nabla\Bp \cdot\nabla\psi / \left(R\Bp\right)^2
\end{align*}
%
The derivatives of $\Bp$ in $R$ and $Z$ are:
%
\begin{align*}
\deriv{\Bp}{R} =& -\frac{\Bp}{R} + \frac{1}{\Bp
R^2}\left[\deriv{\psi}{R}\dderiv{\psi}{R} +
\deriv{\psi}{Z}\frac{\partial^2\psi}{\partial R\partial Z}\right] \\
\deriv{\Bp}{Z} =& \frac{1}{\Bp R^2}\left[\deriv{\psi}{Z}\dderiv{\psi}{Z} +
\deriv{\psi}{R}\frac{\partial^2\psi}{\partial R\partial Z}\right]
\end{align*}
%
For the toroidal field, $\Bt = f/R$
%
\begin{align*}
\deriv{\Bt}{\psi} = \frac{1}{R}\deriv{f}{\psi} - \frac{f}{R^2}\deriv{R}{\psi}
\end{align*}
%
As above, $\deriv{R}{\psi} = \nabla R \cdot\nabla\psi / \left(R\Bp\right)^2$,
and since $\nabla R\cdot\nabla R = 1$,
%
\begin{align*}
\deriv{R}{\psi} = \deriv{\psi}{R} / \left(R\Bp\right)^2
\end{align*}
%
similarly,
%
\begin{align*}
\deriv{Z}{\psi} = \deriv{\psi}{Z} / \left(R\Bp\right)^2
\end{align*}
%
and so the variation of toroidal field with $\psi$ is
%
\begin{align*}
\deriv{\Bt}{\psi} = \frac{1}{R}\deriv{f}{\psi} -
\frac{\Bt}{R^3\Bp^2}\deriv{\psi}{R}
\end{align*}
%
From the definition $B=\sqrt{\Bt^2 + \Bp^2}$,
%
\begin{align*}
\deriv{B}{\psi} = \frac{1}{B}\left(\Bt\deriv{\Bt}{\psi} +
\Bp\deriv{\Bp}{\psi}\right)
\end{align*}



\subsection{Parallel derivative of $B$ field}
To get the parallel gradients of the $B$ field components, start with
%
\begin{align*}
\deriv{}{s}\left(B^2\right) = \deriv{}{s}\left(\Bt^2\right) +
\deriv{}{s}\left(\Bp^2\right)
\end{align*}
%
Using the fact that $R\Bt$ is constant along $s$,
%
\begin{align*}
\deriv{}{s}\left(R^2\Bt^2\right) = R^2\deriv{}{s}\left(\Bt^2\right) +
\Bt^2\deriv{}{s}\left(R^2\right) = 0
\end{align*}
%
which gives
%
\begin{align*}
  \deriv{}{s}\left(\Bt^2\right) = -\frac{\Bt^2}{R^2}\deriv{}{s}\left(R^2\right)
\end{align*}
%
The poloidal field can be calculated from
%
\begin{align*}
\deriv{}{s}\left(\nabla\psi \cdot \nabla\psi\right) =
\deriv{}{s}\left(R^2\Bp^2\right) = R^2\deriv{}{s}\left(\Bp^2\right) +
\Bp^2\deriv{}{s}\left(R^2\right)
\end{align*}
%
Using equation~\ref{eq:flinegradpsi}, $\nabla\psi \cdot \nabla\psi$ can also be
written as
%
\begin{align*}
\nabla\psi \cdot \nabla\psi = B^2R^2\left[\left(\deriv{R}{s}\right)^2 +
\left(\deriv{Z}{s}\right)^2\right]
\end{align*}
%
and so (unsurprisingly)
%
\begin{align*}
\frac{\Bp^2}{B^2} = \left[\left(\deriv{R}{s}\right)^2 +
\left(\deriv{Z}{s}\right)^2\right]
\end{align*}
%
Hence
%
\begin{align*}
\deriv{}{s}\left(\Bp^2\right) = B^2\deriv{}{s}\left[\left(\deriv{R}{s}\right)^2
+ \left(\deriv{Z}{s}\right)^2\right] +
\frac{\Bp^2}{B^2}\deriv{}{s}\left(B^2\right)
\end{align*}
%
Which gives
%
\begin{align*}
\deriv{}{s}\left(B^2\right) = -\frac{B^2}{R^2}\deriv{}{s}\left(R^2\right) +
\frac{B^4}{\Bt^2}\deriv{}{s}\left[\left(\deriv{R}{s}\right)^2 +
\left(\deriv{Z}{s}\right)^2\right]
\end{align*}
%
%
\begin{align*}
\deriv{}{s}\left(\Bp^2\right) = \left(1 +
\frac{\Bp^2}{\Bt^2}\right)B^2\deriv{}{s}\left[\left(\deriv{R}{s}\right)^2 +
\left(\deriv{Z}{s}\right)^2\right] -
\frac{\Bp^2}{R^2}\deriv{}{s}\left(R^2\right)
\end{align*}



\subsection{Magnetic shear from $J\times B$}
Re-arranging the radial force balance equation~\ref{eq:xbalance} gives
%
\begin{align*}
\frac{\Bp^2R}{\Bt}\deriv{\nu}{\psi} + \nu\left(\frac{2RB}{\Bt}\deriv{B}{\psi} +
\frac{B^2}{\Bt}\deriv{R}{\psi} - \frac{B^2R}{\Bt^2}\deriv{\Bt}{\psi}\right) +
\frac{\mu_0\hthe}{\Bp}\deriv{P}{\psi} = 0
\end{align*}



\subsection{Magnetic shear}
The field-line pitch is given by
%
\begin{align*}
\nu = \frac{\hthe\Bt}{\Bp R}
\end{align*}
%
and so
%
\begin{align*}
\deriv{\nu}{\psi} = \frac{\nu}{\hthe}\deriv{\hthe}{\psi} +
\frac{\nu}{\Bt}\deriv{\Bt}{\psi} - \frac{\nu}{\Bp}\deriv{\Bp}{\psi} -
\frac{\nu}{R}\deriv{R}{\psi}
\end{align*}
%
The last three terms are given in the previous section, but
$\partial\hthe/\partial\psi$ needs to be evaluated



\subsection{$\psi$ derivative of $\hthe$}
From the expression for curvature \ref{eq:curvature}, and using $\nabla x \cdot
\nabla \psi = \sbt \left(R\Bp\right)^2$ and $\nabla z\cdot\nabla \psi = -\sbt I
\left(R\Bp\right)^2$
%
\begin{align*}
\kvec\cdot\nabla\psi =& -\sbt
\frac{\Bp}{B\hthe}\rbpsq\left[\deriv{}{x}\left(\frac{B\hthe}{\Bp}\right) -
\sbt\deriv{}{y}\left(\frac{\Bt IR}{B}\right)\right] \\
&- I\rbpsq \frac{\Bp}{B\hthe}\deriv{}{y}\left(\frac{\Bt R}{B}\right)
\end{align*}
%
The second and third terms partly cancel, and using $\deriv{I}{y} = \sbt
\deriv{\nu}{x}$
%
\begin{align*}
  \frac{\kvec\cdot\nabla\psi}{\rbpsq} =&
-\sbt\frac{\Bp}{B\hthe}\deriv{}{x}\left(\frac{B\hthe}{\Bp}\right) +
\sbt\frac{\Bp}{B\hthe}\frac{\Bt R}{B}\deriv{\nu}{x} \\
  =& -\sbt\frac{\Bp}{B\hthe}\left[\deriv{}{x}\left(\frac{B\hthe}{\Bp}\right) -
\frac{\Bt R}{B}\deriv{}{x}\left(\frac{\Bt\hthe}{\Bp R}\right)\right] \\
  =& -\sbt\frac{\Bp}{B\hthe}\left[\hthe\deriv{}{x}\left(\frac{B}{\Bp}\right) -
\hthe\frac{\Bt R}{B}\deriv{}{x}\left(\frac{\Bt}{\Bp R}\right) +
\frac{B^2}{B\Bp}\deriv{\hthe}{x} - \frac{\Bt^2}{B\Bp}\deriv{\hthe}{x}\right] \\
  =& -\sbt \frac{\Bp}{B^2\hthe}\deriv{\hthe}{x} -
\sbt\frac{\Bp}{B^2}\left[B\deriv{}{x}\left(\frac{B}{\Bp}\right) - \Bt
R\deriv{}{x}\left(\frac{\Bt}{\Bp R}\right)\right]
\end{align*}
%
Writing
%
\begin{align*}
B\deriv{}{x}\left(\frac{B}{\Bp}\right) =&
\deriv{}{x}\left(\frac{B^2}{\Bp}\right) - \frac{B}{\Bp}\deriv{B}{x} \\
\Bt R\deriv{}{x}\left(\frac{\Bt}{\Bp R}\right) =&
\deriv{}{x}\left(\frac{\Bt^2}{\Bp}\right) - \frac{\Bt}{\Bp
R}\deriv{}{x}\left(\Bt R\right)
\end{align*}
%
and using $B\deriv{B}{x} = \Bt\deriv{\Bt}{x} + \Bp\deriv{\Bp}{x}$, this
simplifies to give
%
\begin{align}
\frac{\kvec\cdot\nabla\psi}{\rbpsq} =
-\sbt\frac{\Bp^2}{B^2\hthe}\deriv{\hthe}{x} - \sbt\frac{\Bt^2}{B^2
R}\deriv{R}{x}
\label{eq:dhdpsi}
\end{align}
%
This can be transformed into an expression for $\deriv{\hthe}{x}$ involving
only derivatives along
field-lines.
Writing $\nabla R = \deriv{R}{\psi}\nabla\psi + \deriv{R}{\theta}\nabla\theta$,
%
\begin{align*}
\nabla R \cdot \nabla\psi = \deriv{R}{\psi}\rbpsq
\end{align*}
%
Using \ref{eq:flinegradpsi},
%
\begin{align*}
\nabla\psi \cdot \nabla R = -\sbt B R\frac{dZ}{ds}
\end{align*}
%
and so
%
\begin{align*}
\deriv{R}{x} = -\frac{BR}{\rbpsq}\frac{dZ}{ds}
\end{align*}
%
Substituting this and equation \ref{eq:flinekappsi} for $\kvec\cdot\nabla\psi$
into equation~\ref{eq:dhdpsi}
the $\deriv{R}{x}$ term cancels with part of the $\kvec\cdot\nabla\psi$ term,
simplifying to
%
\begin{align*}
\deriv{\hthe}{x} =
-\hthe\frac{B^3R}{\Bp^2\rbpsq}\left[\frac{d^2Z}{ds^2}\frac{dR}{ds} -
\frac{d^2R}{ds^2}\frac{dZ}{ds}\right]
\end{align*}



\section{Shifted radial derivatives}
\label{sec:shiftcoords}
The coordinate system given by equation~\ref{eq:coordtransform} and used in the
above sections has a problem: There is a special poloidal location $\theta_0$
where the radial basis vector $\ve{e}_x$ is purely in the $\nabla\psi$
direction.
Moving away from this location, the coordinate system becomes sheared in 
the toroidal direction.

Making the substitution
%
\begin{align*}
\deriv{}{x} = \deriv{}{\psi} + I\deriv{}{z}
\end{align*}
%
we also get the mixed derivative
%
\begin{align*}
\frac{\partial}{\partial z\partial x} =& \deriv{}{z}\deriv{}{\psi} + 
\deriv{I}{z}\deriv{}{z} + I\frac{\partial^2}{\partial z^2} \nonumber \\
=& \frac{\partial^2}{\partial z\partial \psi} + I\frac{\partial^2}{\partial 
z^2}
\end{align*}
%
and second-order $x$ derivative
%
\begin{align*}
\frac{\partial^2}{\partial x^2} =& \frac{\partial^2}{\partial \psi^2} + 
\deriv{}{\psi}\left(I\deriv{}{z}\right) + I\deriv{}{z}\left(\deriv{}{\psi} + 
I\deriv{}{z}\right) \nonumber \\
=& \frac{\partial^2}{\partial \psi^2} + I^2\frac{\partial^2}{\partial z^2} + 
2I\frac{\partial^2}{\partial z\partial \psi} + \deriv{I}{\psi}\deriv{}{z}
\end{align*}



\subsection{Perpendicular Laplacian}
%
\begin{align*}
\delp = \rbpsq\left[\dderiv{}{x} - 2I\frac{\partial^2}{\partial z\partial x} + 
\left(I^2 + \frac{B^2}{\left(\rbp\right)^4}\right)\dderiv{}{z}\right]
\end{align*}
%
transforms to
%
\begin{align}
\delp = \rbpsq\left[\dderiv{}{\psi} + \deriv{I}{\psi}\deriv{}{z} + 
\frac{B^2}{\left(\rbp\right)^4}\dderiv{}{z}\right]
\label{eq:delp}
\end{align}
%
The extra term involving $I$ disappears, but only if {\bf  both} the $x$ and 
$z$ first derivatives are taken into account:
%
\begin{align*}
\delp = \rbpsq\left[\dderiv{}{x} - 2I\frac{\partial^2}{\partial z\partial x} + 
\left(I^2 + \frac{B^2}{\left(\rbp\right)^4}\right)\dderiv{}{z}\right] + 
\nabla^2 x \deriv{}{x} + \nabla^2 z\deriv{}{z}
\end{align*}
%
with
%
\begin{align*}
\nabla^2 x = \frac{1}{J}\deriv{}{x}\left[J\rbpsq\right]
\end{align*}
%
%
\begin{align}
\nabla^2 z =& \frac{1}{J}\left[-\deriv{}{x}\left(JI\rbpsq\right) - 
\deriv{}{y}\left(\frac{\Bt}{\Bp^2R}\right)\right] \nonumber \\
=& \frac{1}{J}\left[-I\deriv{}{x}\left(J\rbpsq\right) - \deriv{I}{x}J\rbpsq - 
\deriv{}{y}\left(\frac{\Bt}{\Bp^2R}\right)\right] \label{eq:delpz}
\end{align}
%
where $J=\hthe / \Bp$ is the Jacobian. Transforming into $\psi$ derivatives, 
the middle term of equation~\ref{eq:delpz} cancels the $I$ term in 
equation~\ref{eq:delp}, but introduces another $I$ term (first term in 
equation~\ref{eq:delpz}). This term cancels with the $\nabla^2 x$ term when 
$\deriv{}{x}$ is expanded, so the full expression for $\delp$ using $\psi$ 
derivatives is:
%
\begin{align}
\delp =& \rbpsq\left[\dderiv{}{\psi} + 
\frac{B^2}{\left(\rbp\right)^4}\dderiv{}{z}\right] \nonumber \\
&+ \frac{1}{J}\deriv{}{\psi}\left[J\rbpsq\right]\deriv{}{\psi} - 
\frac{1}{J}\deriv{}{y}\left(\frac{\Bt}{\Bp^2R}\right)\deriv{}{z}
\label{eq:delp_shift}
\end{align}



\subsubsection{In orthogonal $\left(\psi, \theta, \zeta\right)$ flux 
coordinates}
For comparison, the perpendicular Laplacian can be derived in orthogonal 
``flux'' coordinates
%
\begin{align*}
\left|\nabla\psi\right| = \rbp \qquad \left|\nabla\theta\right| = 1/\hthe 
\qquad \left|\nabla\zeta\right| = 1/R
\end{align*}
%
The Laplacian operator is given by
%
\begin{align*}
\nabla^2 A =& \rbpsq\dderiv{A}{\psi} + \frac{1}{\hthe^2}\dderiv{A}{\theta} + 
\frac{1}{R^2}\dderiv{A}{\zeta} \nonumber \\
&+ \frac{1}{J}\deriv{}{\psi}\left[J\rbpsq\right]\deriv{A}{\psi} + 
\frac{1}{J}\deriv{}{\theta}\left(J/\hthe^2\right)\deriv{A}{\theta}
\end{align*}
%
parallel derivative by
%
\begin{align*}
\partial_{||} \equiv \bvec\cdot\nabla = \frac{\Bp}{B\hthe}\deriv{}{\theta} + 
\frac{\Bt}{RB}\deriv{}{\zeta}
\end{align*}
%
and so
%
\begin{align*}
\partial^2_{||}A \equiv \partial_{||}\left(\partial_{||}A\right) =& 
\left(\frac{\Bp}{B\hthe}\right)^2\dderiv{A}{\theta} + 
\left(\frac{\Bt}{RB}\right)^2\dderiv{A}{\zeta} \nonumber \\
&+ 2\frac{\Bp\Bt}{B^2\hthe R}\frac{\partial^2 A}{\partial\theta\partial\zeta} 
\nonumber \\
&+ \deriv{}{\theta}\left(\frac{\Bp}{B\hthe}\right)\deriv{A}{\theta} + 
\deriv{}{\theta}\left(\frac{\Bt}{RB}\right)\deriv{A}{\zeta}
\end{align*}
%
Hence in orthogonal flux coordinates, the perpendicular Laplacian is:
%
\begin{align}
\delp \equiv \nabla^2 - \partial_{||}^2 = \rbpsq\left[\dderiv{}{\psi} + 
\frac{1}{R^4B^2}\dderiv{}{\zeta^2}\right] + 
\frac{\Bt^2}{\hthe^2B^2}\dderiv{}{\theta} + \cdots
\label{eq:delp_flux}
\end{align}
%
where the neglected terms are first-order derivatives. The coefficient for the 
second-order $z$
derivative differs from equation~\ref{eq:delp_shift}, and 
equation~\ref{eq:delp_flux} still contains a derivative in $\theta$. This shows 
that the transformation made to get equation~\ref{eq:delp_shift} doesn't result 
in the same answer as orthogonal flux coordinates: equation~\ref{eq:delp_shift} 
is in field-aligned coordinates.

Note that in the limit of $\Bp = B$, both equations~\ref{eq:delp_shift} 
and \ref{eq:delp_flux} are the same, as they should be.



\subsection{Operator $\Bvec\times\nabla\phi\cdot\nabla A$}
%
\begin{align*}
\Bvec\times\nabla\phi\cdot\nabla A =& \left(\deriv{\phi}{x}\deriv{A}{y} - 
\deriv{\phi}{y}\deriv{A}{x}\right)\left(-\Bt\frac{\rbp}{\hthe}\right) \\
&+ \left(\deriv{\phi}{x}\deriv{A}{z} - 
\deriv{\phi}{z}\deriv{A}{x}\right)\left(-B^2\right) \\
&- \left(\deriv{\phi}{y}\deriv{A}{z} - 
\deriv{\phi}{z}\deriv{A}{y}\right)\left(I\Bt\frac{\rbp}{\hthe}\right)
\end{align*}
%
%
\begin{align*}
\Bvec\times\nabla\phi\cdot\nabla A =& \left(\deriv{\phi}{\psi}\deriv{A}{y} + I 
\deriv{\phi}{z}\deriv{A}{y} - \deriv{\phi}{y}\deriv{A}{\psi} - 
I\deriv{\phi}{y}\deriv{A}{z}\right)\left(-\Bt\frac{\rbp}{\hthe}\right) \\
&+ \left(\deriv{\phi}{\psi}\deriv{A}{z} + I\deriv{\phi}{z}\deriv{A}{z} - 
\deriv{\phi}{z}\deriv{A}{\psi} - 
I\deriv{\phi}{z}\deriv{A}{z}\right)\left(-B^2\right) \\
&- \left(\deriv{\phi}{y}\deriv{A}{z} - 
\deriv{\phi}{z}\deriv{A}{y}\right)\left(I\Bt\frac{\rbp}{\hthe}\right)
\end{align*}
%

%
\begin{align*}
\Bvec\times\nabla\phi\cdot\nabla A =& \left(\deriv{\phi}{\psi}\deriv{A}{y} - 
\deriv{\phi}{y}\deriv{A}{\psi}\right)\left(-\Bt\frac{\rbp}{\hthe}\right) 
\nonumber \\
&+ \left(\deriv{\phi}{\psi}\deriv{A}{z} - \deriv{\phi}{z}\deriv{A}{\psi} 
\right)\left(-B^2\right)
\end{align*}
%



\bibliography{references}
\bibliographystyle{unsrt}

\appendix



\section{Differential geometry}
The following is notes from \cite{hazeltine-2003}.

Sets of vectors $\left\{\mathbf{A, B, C}\right\}$ and $\left\{\mathbf{a, b, 
c}\right\}$ are {\bf reciprocal} if
%
\begin{align*}
\mathbf{A\cdot a} = \mathbf{B\cdot b} = \mathbf{C\cdot c} = 1\\
\mathbf{A\cdot b} = \mathbf{A\cdot c} = \mathbf{B\cdot a} = \mathbf{B\cdot c} = 
\mathbf{C\cdot a} = \mathbf{C\cdot b} = 0 \\
\end{align*}
%
which implies that $\left\{\mathbf{A, B, C}\right\}$ and $\left\{\mathbf{a, b, 
c}\right\}$ are each linearly independent.
Equivalently,
%
\begin{align*}
\mathbf{a} = \frac{\mathbf{B\times C}}{\mathbf{A\cdot\left(B\times 
C\right)}}\qquad
\bvec = \frac{\mathbf{C\times A}}{\mathbf{B\cdot\left(C\times 
A\right)}}\qquad
\mathbf{c} = \frac{\mathbf{A\times B}}{\mathbf{C\cdot\left(A\times B\right)}}
\end{align*}
%
Either of these sets can be used as a basis, and any vector $\mathbf{w}$ can be 
represented as
$\mathbf{w} = \left(\mathbf{w\cdot a}\right)\mathbf{A} + \left(\mathbf{w\cdot 
b}\right)\Bvec +
\left(\mathbf{w\cdot c}\right)\mathbf{C}$ or as $\mathbf{w} = 
\left(\mathbf{w\cdot A}\right)\mathbf{a} +
\left(\mathbf{w\cdot B}\right)\bvec + \left(\mathbf{w\cdot 
C}\right)\mathbf{c}$. In the cartesian
coordinate system, the basis vectors are reciprocal to themselves so this 
distinction is not needed.
For a general set of coordinates $\left\{u^1, u^2, u^3\right\}$, {\bf tangent 
basis vectors} can be defined. If
the cartesian coordinates of a point are given by $\left(x, y, z\right) = 
\mathbf{R}\left(u^1, u^2, u^3\right)$
then the tangent basis vectors are:
%
\begin{align*}
\ve{e}_i = \frac{\partial\mathbf{R}}{\partial u^i}
\end{align*}
%
and in general these will vary from point to point. The {\bf scale 
factor} or {\bf metric coefficient}
$h_i =\left|\ve{e}_i\right| $ is the distance moved for a unit change in 
$u^i$. The unit vector
$\hv{e}_i = \ve{e}_i/h_i$. Definitiion of {\bf grad operator}:
%
\begin{center}
\framebox{$\nabla\Phi$ of a function $\Phi$ is defined so that $d\Phi = 
\nabla\Phi\cdot d{\mathbf{R}}$}
\end{center}
%
From the chain rule, $d\mathbf{R} = 
\frac{\partial\mathbf{R}}{\partial u^i}du^i = \ve{e}_idu^i$
and substituting $\Phi = u^i$
%
\begin{align*}
du^i = \nabla u^i\cdot\ve{e}_jdu^j
\end{align*}
%
which can only be true if $\nabla u^i\cdot\ve{e}_j = \delta^i_j$ i.e. if
%
\begin{center}
\framebox{Sets of vectors $\ve{e}^i\equiv\nabla u^i$ and $\ve{e}_j$ are 
reciprocal}
\end{center}
%
Since the sets of vectors $\left\{\ve{e}^i\right\}$ and 
$\left\{\ve{e}_i\right\}$ are reciprocal,
any vector $\mathbf{D}$ can be written as $\mathbf{D} = D_i\ve{e}^i = 
D^i\ve{e}_i$ where
$D_i = \mathbf{D\cdot e}_i$ are the {\bf covariant components} and $D^i = 
\mathbf{D\cdot e}^i$ are the
{\bf contravariant components}. To convert between covariant and contravariant 
components, define the
{\bf metric coefficients} $g_{ij} = \mathbf{e_i\cdot e_j}$ and $g^{ij} = 
\mathbf{e^i\cdot e^j}$ so that
$\ve{e}_i = g_{ij}\ve{e}^j$. $g_{ij}$ and $g^{ij}$ are symmetric and if 
the basis is orthogonal
then $g_{ij}=g^{ij} = 0$ for $i\neq j$ i.e. the metric is diagonal.
%
\begin{center}
\framebox{$g_{ij} = h_ih_j\hv{e}_i\cdot\hv{e}_j$ and so 
$g_{ii} = h_i^2$}
\end{center}
%
For a general set of coordinates, the grad operator can be expressed as
%
\begin{align*}
\nabla = \frac{\partial}{\partial u_i}\nabla u_i
\end{align*}
%
and for a general set of (differentiable) coordinates 
$\left\{u^i\right\}$, the laplacian is given by
%
\begin{align}
\nabla^2\phi = \frac{1}{J}\frac{\partial}{\partial 
u^i}\left(Jg^{ij}\frac{\partial\phi}{\partial u^j}\right)
\label{eq:laplacegen}
\end{align}
%
which can be expanded as
%
\begin{align}
\nabla^2\phi = g^{ij}\frac{\partial^2\phi}{\partial u^i\partial u^j} +
\underbrace{\frac{1}{J}\frac{\partial}{\partial 
u^i}\left(Jg^{ij}\right)}_{-\Gamma^j}\frac{\partial\phi}{\partial u^j}
\label{eq:laplace_expand}
\end{align}
%
where $\Gamma^j$ are the {\bf connection coefficients}. Setting $\phi 
= u^k$ in equation (\ref{eq:laplacegen})
gives $\nabla^2u^k = -\Gamma^k$. Expanding (\ref{eq:laplacegen}) and setting 
$\left\{u^i\right\} = \left\{x, y, z\right\}$ gives
%
\begin{align}
\nabla^2f = \nabla\cdot\nabla f = \nabla\cdot\left(\frac{\partial}{\partial 
x}\nabla x + \frac{\partial}{\partial y}\nabla y + \frac{\partial}{\partial 
z}\nabla z\right) \nonumber \\
\label{eq:general_laplacian}
= \frac{\partial^2 f}{\partial x^2}\left|\nabla x\right|^2 + \frac{\partial^2 
f}{\partial y^2}\left|\nabla y\right|^2 + \frac{\partial^2 f}{\partial 
z^2}\left|\nabla z\right|^2 \\
+2\frac{\partial^2 f}{\partial x\partial y}\left(\nabla x\cdot\nabla y\right)
+2\frac{\partial^2 f}{\partial x\partial z}\left(\nabla x\cdot\nabla z\right)
+2\frac{\partial^2 f}{\partial y\partial z}\left(\nabla y\cdot\nabla z\right) 
\nonumber \\
+\nabla^2x\frac{\partial f}{\partial x} +\nabla^2y\frac{\partial f}{\partial y} 
+ \nabla^2z\frac{\partial f}{\partial z} \nonumber
\end{align}
%
Curl defined as:
%
\begin{align*}
\nabla\times\mathbf{A} = \frac{1}{\sqrt{g}}\sum_k\left(\frac{\partial 
A_j}{\partial u_i} - \frac{\partial A_i}{\partial u_j}\right)\ve{e}_k \qquad 
i,j,k \texttt{ cyc } 1,2,3
\end{align*}
%
Cross-product relation between contravariant and covariant vectors:
%
\begin{align*}
\ve{e}^i = \frac{1}{J}\left(\ve{e}_j \times \ve{e}_k\right) \qquad 
\ve{e}_i = J\left(\ve{e}^j \times \ve{e}^k\right) \qquad i,j,k 
\texttt{ cyc } 1,2,3
\end{align*}



\section{Divergence of ExB velocity}
%
\begin{align*}
\ve{v}_{ExB} = \frac{\ve{b}\times\nabla\phi}{B}
\end{align*}
%
Using
%
\begin{align*}
\nabla\cdot\left(\ve{F}\times\ve{G}\right) = 
\left(\nabla\times\ve{F}\right)\cdot\ve{G} - 
\ve{F}\cdot\left(\nabla\times\ve{G}\right)
\end{align*}
%
the divergence of the $\ve{E}\times\ve{B}$ velocity
can be written as
%
\begin{align}
\nabla\cdot\left(\frac{1}{B}\ve{b}\times\nabla\phi\right) = 
\left[\nabla\times\left(\frac{1}{B}\ve{b}\right)\right]\cdot\nabla\phi - 
\frac{1}{B}\ve{b}\cdot\nabla\times\nabla\phi
\label{eq:exb1}
\end{align}
%
The second term on the right is identically zero (curl of a gradient). The 
first term on the right can be expanded as
%
\begin{align*}
\left[\nabla\times\left(\frac{1}{B}\ve{b}\right)\right]\cdot\nabla\phi = 
\left[\nabla\left(\frac{1}{B}\right)\times\ve{b} + 
\frac{1}{B}\nabla\times\ve{b}\right]\cdot\nabla\phi
\end{align*}
%
Using
%
\begin{align*}
\ve{b}\times\ve{\kappa} = \nabla\times\ve{b} - 
\ve{b}\left[\ve{b}\cdot\left(\nabla\times\ve{b}\right)\right]
\end{align*}
%
this becomes:
%
\begin{align*}
  \nabla\cdot\left(\frac{1}{B}\ve{b}\times\nabla\phi\right) = 
&-\ve{b}\times\nabla\left(\frac{1}{B}\right)\cdot\nabla\phi \\
  &+ \frac{1}{B}\ve{b}\times\ve{\kappa}\cdot\nabla\phi \\
  &+ 
\left[\ve{b}\cdot\left(\nabla\times\ve{b}\right)\right]\ve{b}\cdot\nabla\phi
\end{align*}
%
Alternatively, equation~\ref{eq:exb1} can be expanded as
%
\begin{align*}
  \nabla\cdot\left(\frac{1}{B}\ve{b}\times\nabla\phi\right) =& 
-B\ve{b}\times\nabla\left(\frac{1}{B^2}\right)\cdot\nabla\phi + 
\frac{1}{B^2}\nabla\times\ve{B}\cdot\nabla\phi \\
  =& -B\ve{b}\times\nabla\left(\frac{1}{B^2}\right)\cdot\nabla\phi + 
\frac{1}{B^2}\ve{J}\cdot\nabla\phi
\end{align*}
%
\end{document}